# -*- coding: utf-8 -*-
"""RAG_VNese_Dataset_create_vector_Search .ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bzraoB64x586dsPty5NVKvy_CAr4HpEi
"""

# !pip install -q datasets pandas pymongo sentence_transformers

# !pip install -q accelerate

# !pip install pymongo[srv]

import pymongo
import pandas as pd
# from google.colab import userdata

# Connect to MongoDB
# VNLaws
# vnlaw1234
# mongodb+srv://VNLaws:<db_password>@rag-cluster.issqlbf.mongodb.net/?appName=rag-cluster
from pymongo import MongoClient

client = MongoClient(
    "mongodb+srv://VNLaws:<L!nkboong91>@rag-cluster.issqlbf.mongodb.net/?appName=rag-cluster"
)

# pymongo.MongoClient(userdata.get('mongo_url')) #Update MongoDB connection string
db = client["DBName"]
collection = db["article_details_clean"]
df.drop('_id', axis=1, inplace = True)
df.drop('url', axis =1, inplace = True)

#Retrieve data from MongoDB
data = list(collection.find()) #search all collection (table) in MongoDB to data frame
#Convert data to Data Frame using Pandas
df = pd.DataFrame(data)
#Preprocessing Data here

df.head()

# !pip install sentence_transformers

from sentence_transformers import SentenceTransformer
embedding_model = SentenceTransformer("keepitreal/vietnamese-sbert")
def get_embedding(text: str) -> list[float]:
  if not text.strip():
    print("Attempted to get embedding for empty text.")
    return []
  embedding = embedding_model.encode(text)
  return embedding.tolist()

df["embedding"] = df["title"].apply(get_embedding) #embedding "title" column
df.head

collection = db["embedding_for_vector_"]

collection.delete_many({})

documents = df.to_dict("records")
collection.insert_many(documents)
print("Data ingestion into MongoDB completed")